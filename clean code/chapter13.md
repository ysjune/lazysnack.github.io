## 13. 동시성

#### 동시성이 필요한 이유?
동시성은 커플링(결합)을 없애는 전략이다, 즉 무엇과 언제를 분리하는 전략이다 <br/>
단일 스레드의 경우 호출 스택을 살펴보면 프로그램 상태가 곧바로 드러난다. <br/>
응답 시간과 작업 처리량 혹은 한 번에 한 사람만 처리하는 경우, 정보를 대량으로 분석하는 경우, 이런 경우를 위해 동시성이 필요하다 할 수 있다.

#### 미신과 오해
 > - 동시성은 성능을 높여준다 (때때로 높여준다, 각 스레드가 독립적인 행동을 취할 때)
 > - 동시성을 구현해도 설계가 바뀌지 않는다 (단일과 다중 스레드 시스템은 설계가 판이하게 다름)
 > - 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다 (오히려 더 알아야 한다. 동시 수정, 데드락 등을 피하기 위해)
 
#### 타당한 생각
 > - 동시성은 다소 부하를 유발한다 (성능 측면에서 부하가 걸리며, 코드도 더 짜야됨)
 > - 동시성은 복잡하다.
 > - 동시성 버그는 재현이 어렵다 (그렇기에 일회성 문제로 여겨 무시되는 경우가 생김)
 > - 동시성을 구현하려면 근본적인 설계 전략을 재고해야 됨

#### 난관
두 스레드가 있을 때 두 스레드가 자바 코드 한 줄을 거쳐가는 경로는 수 없이 많다. <br/>
대부분 올바른 결과를 내놓지만, 일부가 잘못된 결과를 내놓고, 이 경우가 드물다 <br/>

#### 동시성 방어 원칙

1. 단일 책임 원칙
동시성은 복잡성 하나만으로 충분히 분리할만한 가치가 있으며, 동시성을 구현할 때는 다음을 고려한다.

  > - 동시성 코드는 독자적인 개발, 변경, 조율 주기가 있다.
  > - 독자적인 난관이 있으며, 다른 코드에서 겪는 난관과는 난이도가 다르다.
  > - 잘못 구현된 코드는 별의 별 방식으로 실패한다.

  **권장사항** : 동시성 코드는 다른 코드와 분리하라. <br/>
  
2. 따름 정리 : 자료 범위를 제한하라
두 스레드가 공유하는 영역을 synchronized 키워드로 보호한다. 이런 임계영역의 수는 줄여야 하고, 공유 영역이 많아질 수록 다음 가능성도 커진다

  > - 보호할 임계영역을 빼먹어서 공유 자료를 수정하는 모든 코드를 망가뜨린다.
  > - 모든 임계영역을 보호했는지 확인하느라 똑같은 노력과 수고를 반복한다.
  > - 찾아내기 어려운 버그가 더 찾기 어려워진다.
  
  **권장 사항** : 자료를 캡술화 하고, 공유 자료를 최대한 줄여라<br/>
  
3. 따름 정리 : 자료 사본을 사용하라
공유 자료를 줄이려면 처음부터 공유하지 않는 방법이 최상이다. 이럴 경우 원본은 두고 사본을 사용하는 방법이 있는데 <br/>
객체를 복사하는 시간이 걸린다면 테스트를 통해 측정해본다. 하지만 사본으로 동기화를 피할 수 있다면 내부 잠금을 없애 절약한 수행 시간이 <br/>
사본 생성과 가비지 컬렉션에 드는 부하를 상쇄할 가능성이 크다.<br/>

4. 따름 정리 : 스레드는 가능한 독립적으로 구현하라
다른 스레드와 자료를 공유하지 않는다. 각 스레드는 클라이언트 요청 하나를 처리한다. 그러면 각 스레드는 세상에 자신만 있는 듯이 돌아갈 수 있다.<br/>
  
  **권장 사항** : 독자적인 스레드로, 가능하면 다른 프로세서에서 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라.<br/>
  
  
 
